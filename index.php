<?php require_once 'config.php'; ?>
<!doctype html>
<html lang="en">
<head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Supermarket - Local</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<style>body{background:#f4f7fb} .card-ghost{background:#fff;padding:20px;border-radius:12px;box-shadow:0 6px 18px rgba(11,79,139,0.06)} .brand{color:#0b4f8b;font-weight:700}</style>
</head>
<body>
<nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm"><div class="container"><a class="navbar-brand brand" href="#">Supermarket</a><div id="navRight"><?php if(isset($_SESSION['user'])): ?><span class="me-2 text-muted">Hi, <?=htmlspecialchars($_SESSION['user']['username'])?></span><button id="btn-logout" class="btn btn-outline-secondary btn-sm">Logout</button><?php else: ?><button id="btn-open-login" class="btn btn-primary btn-sm">Admin Login</button><?php endif;?></div></div></nav>
<div class="container my-4"><div id="app">
<?php if(!isset($_SESSION['user'])): ?>
  <div class="row justify-content-center"><div class="col-md-6"><div class="card-ghost"><h4>Login</h4><div id="loginAlert" class="alert alert-danger d-none"></div><div class="mb-3"><label>Username</label><input id="loginUser" class="form-control" value="admin"></div><div class="mb-3"><label>Password</label><input id="loginPass" class="form-control" type="password" value="1234"></div><div class="text-end"><button id="loginBtn" class="btn btn-primary">Login</button></div></div></div></div>
<?php else: ?>
  <div class="row"><div class="col-md-3"><div class="card-ghost"><h5>Menu</h5><div class="list-group"><a href="#" class="list-group-item list-group-item-action" data-view="dashboard">Dashboard</a><a href="#" class="list-group-item list-group-item-action" data-view="items">Items</a><a href="#" class="list-group-item list-group-item-action" data-view="sales">Sales (POS)</a><a href="#" class="list-group-item list-group-item-action" data-view="reports">Reports</a><a href="#" class="list-group-item list-group-item-action" data-view="settings">Settings</a></div></div></div><div class="col-md-9" id="viewArea"></div></div>
<?php endif; ?>
</div></div>
<script>
const API = 'api.php';
function postForm(action, data){ const fd = new FormData(); fd.append('action', action); for(const k in data) fd.append(k, data[k]); return fetch(API,{method:'POST',body:fd}).then(r=>r.json()); }
function getJson(url){ return fetch(url).then(r=>r.json()); }
const loginBtn = document.getElementById('loginBtn');
if(loginBtn){ loginBtn.addEventListener('click', ()=>{ const u=document.getElementById('loginUser').value; const p=document.getElementById('loginPass').value; postForm('login',{username:u,password:p}).then(res=>{ if(res.ok) location.reload(); else { const a=document.getElementById('loginAlert'); a.classList.remove('d-none'); a.textContent=res.msg||'Error'; } }); }); }
document.addEventListener('click', function(e){ if(e.target.matches('[data-view]')){ e.preventDefault(); loadView(e.target.dataset.view); } if(e.target.id==='btn-logout'){ postForm('logout',{}).then(()=> location.reload()); } });
function loadView(name){ const area=document.getElementById('viewArea'); if(name==='dashboard'){ area.innerHTML='<div class="card-ghost"><h4>Dashboard</h4><div id="dashContent">Loading...</div></div>'; fetch('api.php?action=items_list').then(r=>r.json()).then(ir=>{ fetch('api.php?action=reports_sales').then(r=>r.json()).then(salesRes=>{ const items=ir.items; const sales=salesRes.sales||[]; let low=items.filter(it=>it.qty<=it.low_threshold); let html='<div class="row"><div class="col-md-6"><div><strong>Total Items:</strong> '+items.length+'</div><div class="mt-2"><strong>Low stock:</strong> '+low.length+'</div></div><div class="col-md-6"><strong>Recent sales:</strong><ul>'; for(let i=0;i<Math.min(5,sales.length);i++){ html+='<li>'+sales[i].sale_ref+' — $'+sales[i].total+' — '+sales[i].created_at+'</li>' } html+='</ul></div></div>'; document.getElementById('dashContent').innerHTML=html; }) }) } if(name==='items'){ area.innerHTML='<div class="card-ghost"><h4>Items <button id="btnAddItem" class="btn btn-sm btn-primary float-end">Add</button></h4><div id="itemsList">Loading...</div></div>'; loadItemsList(); document.getElementById('btnAddItem').addEventListener('click', ()=> showItemForm()); } if(name==='sales'){ area.innerHTML='<div class="card-ghost"><h4>Sales (POS)</h4><div id="posArea">Loading POS...</div></div>'; loadPos(); } if(name==='reports'){ area.innerHTML='<div class="card-ghost"><h4>Reports</h4><div id="reportsArea">Loading...</div></div>'; loadReports(); } if(name==='settings'){ area.innerHTML='<div class="card-ghost"><h4>Settings</h4><div id="settingsArea">Loading...</div></div>'; loadSettings(); } }
function loadItemsList(){ fetch('api.php?action=items_list').then(r=>r.json()).then(res=>{ const c=document.getElementById('itemsList'); if(!res.ok) return c.innerHTML='Error'; let html='<table class="table"><thead><tr><th>Name</th><th>Qty</th><th>Price</th><th>Low</th><th>Actions</th></tr></thead><tbody>'; res.items.forEach(it=>{ html+='<tr><td>'+it.name+'</td><td>'+it.qty+'</td><td>$'+parseFloat(it.price).toFixed(2)+'</td><td>'+it.low_threshold+'</td><td><button class="btn btn-sm btn-outline-primary" data-edit="'+it.id+'">Edit</button> <button class="btn btn-sm btn-outline-danger" data-del="'+it.id+'">Delete</button></td></tr>'; }); html+='</tbody></table>'; c.innerHTML=html; Array.from(c.querySelectorAll('[data-edit]')).forEach(b=>b.addEventListener('click', e=>{ const id=e.target.getAttribute('data-edit'); editItem(id); })); Array.from(c.querySelectorAll('[data-del]')).forEach(b=>b.addEventListener('click', e=>{ const id=e.target.getAttribute('data-del'); if(confirm('Delete item?')) postForm('items_delete',{id}).then(()=> loadItemsList()); })); }); }
function showItemForm(item=null){ const modalHtml='<div class="card p-3"><h5>'+(item? 'Edit':'Add')+' Item</h5><div><label>Name</label><input id="it_name" class="form-control" value="'+(item? item.name:'')+'"></div><div class="mt-2"><label>Qty</label><input id="it_qty" type="number" class="form-control" value="'+(item? item.qty:0)+'"></div><div class="mt-2"><label>Price</label><input id="it_price" type="number" step="0.01" class="form-control" value="'+(item? item.price:0)+'"></div><div class="mt-2"><label>Low threshold</label><input id="it_low" type="number" class="form-control" value="'+(item? item.low_threshold:5)+'"></div><div class="mt-3 text-end"><button id="it_save" class="btn btn-primary">'+(item? 'Save':'Add')+'</button></div></div>'; const wrapper=document.createElement('div'); wrapper.className='position-fixed top-0 start-0 w-100 h-100 d-flex align-items-center justify-content-center'; wrapper.style.background='rgba(0,0,0,0.4)'; wrapper.innerHTML=modalHtml; document.body.appendChild(wrapper); wrapper.addEventListener('click', (ev)=>{ if(ev.target===wrapper) wrapper.remove(); }); document.getElementById('it_save').addEventListener('click', ()=>{ const name=document.getElementById('it_name').value; const qty=document.getElementById('it_qty').value; const price=document.getElementById('it_price').value; const low=document.getElementById('it_low').value; if(item){ postForm('items_update',{id:item.id,name,qty,price,low}).then(r=>{ wrapper.remove(); loadItemsList(); }); } else { postForm('items_add',{name,qty,price,low}).then(r=>{ wrapper.remove(); loadItemsList(); }); } }); }
function editItem(id){ fetch('api.php?action=items_list').then(r=>r.json()).then(res=>{ const it=res.items.find(x=>x.id==id); if(it) showItemForm(it); }) }
function loadPos(){ fetch('api.php?action=items_list').then(r=>r.json()).then(res=>{ const area=document.getElementById('posArea'); const items=res.items; let html='<div class="row"><div class="col-md-6"><input id="posSearch" class="form-control mb-2" placeholder="Search item..."><div id="posItemsList" style="max-height:400px;overflow:auto">'; items.forEach(it=>{ html+='<div class="d-flex justify-content-between align-items-center border-bottom py-2"><div><strong>'+it.name+'</strong><div class="small text-muted">$'+parseFloat(it.price).toFixed(2)+' • '+it.qty+' in stock</div></div><div><input type="number" min="1" value="1" data-id="'+it.id+'" class="form-control form-control-sm pos-qty" style="width:80px;display:inline-block"> <button class="btn btn-sm btn-primary ms-2 pos-add" data-id="'+it.id+'" data-name="'+it.name+'" data-price="'+it.price+'">Add</button></div></div>'; }); html+='</div></div><div class="col-md-6"><h5>Cart</h5><div id="posCart">No items</div><div class="mt-3 text-end"><button id="posPay" class="btn btn-success">Confirm (Paid)</button> <button id="posCredit" class="btn btn-outline-secondary">Confirm (Credit)</button></div></div></div>'; area.innerHTML=html; const cart=[]; function renderCart(){ const c=document.getElementById('posCart'); if(cart.length===0) return c.innerHTML='<div class="small text-muted">No items</div>'; let out='<table class="table table-sm"><thead><tr><th>Item</th><th>Qty</th><th>Unit</th><th>Total</th><th></th></tr></thead><tbody>'; let total=0; cart.forEach((it,i)=>{ const sub=it.qty*it.price; total+=sub; out+='<tr><td>'+it.name+'</td><td><input type="number" min="1" data-i="'+i+'" class="cart-qty form-control form-control-sm" value="'+it.qty+'" style="width:80px"></td><td>$'+it.price.toFixed(2)+'</td><td>$'+sub.toFixed(2)+'</td><td><button class="btn btn-sm btn-danger cart-remove" data-i="'+i+'">X</button></td></tr>'; }); out+='</tbody></table><div class="text-end"><strong>Total: $'+total.toFixed(2)+'</strong></div>'; c.innerHTML=out; Array.from(c.querySelectorAll('.cart-remove')).forEach(b=> b.addEventListener('click', e=>{ cart.splice(e.target.dataset.i,1); renderCart(); })); Array.from(c.querySelectorAll('.cart-qty')).forEach(inp=> inp.addEventListener('change', e=>{ const idx=e.target.dataset.i; cart[idx].qty=parseInt(e.target.value); renderCart(); })); } Array.from(area.querySelectorAll('.pos-add')).forEach(btn=> btn.addEventListener('click', e=>{ const id=btn.dataset.id; const name=btn.dataset.name; const price=parseFloat(btn.dataset.price); const qtyInput=btn.parentElement.querySelector('.pos-qty'); const qty=parseInt(qtyInput.value)||1; const existing=cart.find(x=> x.id==id); if(existing) existing.qty+=qty; else cart.push({id,name,price,qty}); renderCart(); })); document.getElementById('posPay').addEventListener('click', ()=> submitSale('Paid')); document.getElementById('posCredit').addEventListener('click', ()=>{ const cname=prompt('Geli magaca customer (Credit):'); if(!cname) return alert('Customer name required'); submitSale('Credit', cname); }); function submitSale(status, customer=null){ if(cart.length===0) return alert('No items in cart'); const payload={action:'sales_create', items:cart.map(x=>({item_id:x.id, name:x.name, qty:x.qty, price:x.price})), status, customer}; fetch('api.php',{method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(payload)}).then(r=>r.json()).then(res=>{ if(res.ok){ alert('Sale recorded: '+res.ref); location.reload(); } else alert(res.msg||'Error'); }); } }); }
function loadReports(){ const out='<div><div class="row mb-2"><div class="col-md-3"><input type="date" id="r_from" class="form-control"></div><div class="col-md-3"><input type="date" id="r_to" class="form-control"></div><div class="col-md-6 text-end"><button id="r_filter" class="btn btn-sm btn-primary">Filter</button></div></div><div id="r_results"></div></div>'; document.getElementById('reportsArea').innerHTML=out; document.getElementById('r_filter').addEventListener('click', ()=>{ const from=document.getElementById('r_from').value; const to=document.getElementById('r_to').value; fetch(`api.php?action=reports_sales${from? '&from='+from: ''}${to? '&to='+to: ''}`).then(r=>r.json()).then(res=>{ if(!res.ok) return document.getElementById('r_results').innerHTML='Error'; let html='<table class="table"><thead><tr><th>Ref</th><th>Date</th><th>Total</th><th>Status</th><th>Customer</th></tr></thead><tbody>'; let total=0; res.sales.forEach(s=>{ html+='<tr><td>'+s.sale_ref+'</td><td>'+s.created_at+'</td><td>$'+parseFloat(s.total).toFixed(2)+'</td><td>'+s.status+'</td><td>'+ (s.customer_name||'') +'</td></tr>'; total+=parseFloat(s.total); }); html+='</tbody></table><div class="text-end"><strong>Grand Total: $'+total.toFixed(2)+'</strong></div>'; document.getElementById('r_results').innerHTML=html; }); }); }
function loadSettings(){ const area=document.getElementById('settingsArea'); area.innerHTML='<div><h5>Change Admin Password</h5><div class="mb-2"><input id="oldPw" type="password" class="form-control" placeholder="Old password"></div><div class="mb-2"><input id="newPw" type="password" class="form-control" placeholder="New password"></div><div class="text-end"><button id="savePw" class="btn btn-primary">Save</button></div></div><hr><div><button id="exportSales" class="btn btn-outline-secondary">Export Sales CSV</button></div>'; document.getElementById('savePw').addEventListener('click', ()=>{ const old=document.getElementById('oldPw').value; const nw=document.getElementById('newPw').value; postForm('change_password',{old:old,new:nw}).then(res=>{ if(res.ok) alert('Password changed'); else alert(res.msg||'Error'); }) }); document.getElementById('exportSales').addEventListener('click', ()=>{ window.location.href='api_export_sales.php'; }); }
</script>
</body></html>